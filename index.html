<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sailing Sheet Sync</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #eee; }
        #map { height: 100vh; width: 100vw; z-index: 1; display:none; }
        
        /* LOGIN */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #002b5c; color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 3000; overflow-y: auto;
        }
        .box { background: white; color: #333; padding: 25px; border-radius: 12px; width: 85%; max-width: 320px; text-align: center; margin: 20px 0; }
        
        /* PANELS */
        .ui-panel {
            position: absolute; background: rgba(255, 255, 255, 0.96);
            padding: 12px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000; width: 90%; max-width: 350px; left: 50%; transform: translateX(-50%);
        }
        #settings-panel { top: 50px; display: none; }
        #rescue-panel { top: 20px; display: none; text-align: center; }
        #info-panel { bottom: 20px; text-align: center; display:none; }
        
        /* CONTROLS */
        input, button { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 6px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; }
        button { font-weight: bold; color: white; border: none; cursor: pointer; transition: opacity 0.2s; }
        button:active { opacity: 0.7; }
        .btn-blue { background: #007bff; }
        .btn-orange { background: #e65100; }
        .btn-green { background: #28a745; }

        /* MARKERS */
        .mark-label { background: rgba(255,255,255,0.9); padding: 1px 5px; font-weight: bold; font-size: 11px; border:1px solid #333; border-radius:3px; position:absolute; top:-16px; left:50%; transform:translateX(-50%); white-space:nowrap; }
        .shape-cyl { width: 20px; height: 20px; background: #ff0055; border-radius: 50%; border: 2px solid white; box-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .shape-tri { width: 0; height: 0; border-left: 12px solid transparent; border-right: 12px solid transparent; border-bottom: 24px solid #ffd700; filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.3)); }
        .shape-boat { width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 25px solid #0044ff; }
        .shape-pin { width: 16px; height: 16px; background: orange; border-radius: 50%; border: 2px solid black; }
        .shape-flag { width: 10px; height: 20px; background: blue; border: 1px solid white; }
    </style>
</head>
<body>

    <!-- 1. LOGIN SCREEN -->
    <div id="login-screen">
        <h2 style="margin-top:0;">‚õµ Sailing Sheet Sync</h2>
        <div class="box">
            
            <!-- HIDDEN URL INPUT (Pre-filled) -->
            <input type="hidden" id="script-url" value="https://script.google.com/macros/s/AKfycbymUYipd9QbsR1z9FZFW6H-0k1_Sous0P07Rk_SUSEr8Ieq2rOVQbFQjXIWO10n5R1Geg/exec">

            <p style="margin-bottom:5px; font-weight:bold; color:#555;">Enter Course Name</p>
            <input type="text" id="course-name" placeholder="e.g. race1">

            <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">

            <button class="btn-blue" onclick="startApp('PRO')">I am Start Boat (Save)</button>
            <button class="btn-orange" onclick="startApp('RESCUE')">I am Rescue Boat (Read)</button>
            
            <div style="margin-top:10px; font-size:13px; text-align: left; background: #f9f9f9; padding: 10px; border-radius: 5px;">
                <label style="display:flex; align-items:center;">
                    <input type="checkbox" id="chk-dummy" style="width:auto; margin-right:10px;"> 
                    Enable Dummy GPS (Tap Map)
                </label>
            </div>
        </div>
    </div>

    <!-- MAP -->
    <div id="map"></div>

    <!-- 3. PRO CONTROLS -->
    <div id="settings-panel" class="ui-panel">
        <div style="display:flex; gap:10px;">
            <div style="flex:1">
                <label style="font-size:11px; font-weight:bold;">Wind ¬∞</label>
                <input type="number" id="inp-wind" placeholder="Deg">
            </div>
            <div style="flex:1">
                <label style="font-size:11px; font-weight:bold;">Dist (NM)</label>
                <input type="number" id="inp-dist" value="1.0" step="0.1" placeholder="NM">
            </div>
        </div>
        <button id="btn-save" class="btn-green" onclick="saveToCloud()">‚òÅÔ∏è Save to Cloud</button>
        <div id="save-status" style="font-size:11px; text-align:center; color:#666;">Ready</div>
    </div>

    <!-- 4. RESCUE CONTROLS -->
    <div id="rescue-panel" class="ui-panel">
        <strong id="display-name" style="color:#007bff; font-size:14px;"></strong>
        <button id="btn-load" class="btn-orange" onclick="loadFromCloud()" style="margin-top:10px;">üîÑ Update from Cloud</button>
        <div id="load-status" style="font-size:11px; text-align:center; color:#666;">Click to load</div>
    </div>

    <!-- 5. INFO PANEL -->
    <div id="info-panel" class="ui-panel">
        <div id="target-info" style="font-size: 18px; color:#0056b3; font-weight:bold; margin-bottom:5px;">No Course Loaded</div>
        <div style="font-size:13px;">COG: <span id="val-cog">--</span>¬∞ | SOG: <span id="val-sog">--</span> kn</div>
    </div>

    <script>
        // --- STATE ---
        let map, boatMarker, layer = L.layerGroup();
        let isPro = false, isDummy = false;
        let scriptUrl = "";
        let courseName = "";
        let myPos = { lat: 50.8, lng: -1.2, heading: 0 };
        let activeMarks = [];

        function startApp(role) {
            scriptUrl = document.getElementById('script-url').value.trim();
            courseName = document.getElementById('course-name').value.trim();
            
            if(!scriptUrl) return alert("Error: Script URL is missing in code.");
            if(courseName.length < 2) return alert("Please enter a Course Name (e.g. race1)");

            isPro = (role === 'PRO');
            isDummy = document.getElementById('chk-dummy').checked;

            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('map').style.display = 'block';
            document.getElementById('info-panel').style.display = 'block';
            
            if(isPro) {
                document.getElementById('settings-panel').style.display = 'block';
            } else {
                document.getElementById('rescue-panel').style.display = 'block';
                document.getElementById('display-name').innerText = "Course: " + courseName;
                loadFromCloud(); // Auto load first time
            }

            initMap();
            initGPS();
        }

        // --- GOOGLE SHEETS SYNC ---
        
        async function saveToCloud() {
            if(!isPro) return;
            const btn = document.getElementById('btn-save');
            const status = document.getElementById('save-status');
            
            const w = parseFloat(document.getElementById('inp-wind').value);
            const d = parseFloat(document.getElementById('inp-dist').value);
            if(!w || !d) return alert("Enter Wind and Distance");

            // Prepare Data
            const courseData = {
                start: { lat: myPos.lat, lng: myPos.lng },
                wind: w, dist: d
            };

            // UI Feedback
            btn.disabled = true; btn.innerText = "Saving...";
            
            try {
                // Construct URL with parameters
                const dataStr = encodeURIComponent(JSON.stringify(courseData));
                const url = `${scriptUrl}?action=save&code=${courseName}&data=${dataStr}`;
                
                await fetch(url);
                
                status.innerText = "Saved at " + new Date().toLocaleTimeString();
                render(courseData); // Render locally
            } catch(e) {
                alert("Error saving: " + e);
                status.innerText = "Save Failed";
            }
            
            btn.disabled = false; btn.innerText = "‚òÅÔ∏è Save to Cloud";
        }

        async function loadFromCloud() {
            const btn = document.getElementById('btn-load');
            const status = document.getElementById('load-status');
            
            btn.disabled = true; btn.innerText = "Loading...";

            try {
                const url = `${scriptUrl}?action=read&code=${courseName}&t=${Date.now()}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if(data && data.start) {
                    render(data);
                    status.innerText = "Updated: " + new Date().toLocaleTimeString();
                } else {
                    status.innerText = "No data found for '" + courseName + "'";
                }
            } catch(e) {
                status.innerText = "Connection Error";
                console.error(e);
            }

            btn.disabled = false; btn.innerText = "üîÑ Update from Cloud";
        }

        // --- MAPPING & MATH ---

        function initMap() {
            map = L.map('map').setView([50.8, -1.2], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
            layer.addTo(map);
            if(isDummy) {
                map.on('click', e => updatePos(e.latlng.lat, e.latlng.lng, 0, 0));
                setTimeout(() => updatePos(50.8, -1.2, 0, 0), 500);
            }
        }

        function initGPS() {
            if(isDummy) return;
            if("geolocation" in navigator) {
                navigator.geolocation.watchPosition(
                    p => updatePos(p.coords.latitude, p.coords.longitude, p.coords.heading, p.coords.speed),
                    e => console.log(e), { enableHighAccuracy: true }
                );
            }
        }

        function updatePos(lat, lng, hdg, spd) {
            myPos = { lat, lng, heading: hdg || 0 };
            document.getElementById('val-cog').innerText = Math.round(myPos.heading);
            document.getElementById('val-sog').innerText = spd ? (spd * 1.94).toFixed(1) : "0.0";

            if(!boatMarker) {
                boatMarker = L.marker([lat, lng], {
                    icon: L.divIcon({ className: 'b', html: `<div class="shape-boat" style="transform:rotate(0deg);"></div>`, iconSize: [20, 25], iconAnchor: [10, 12] })
                }).addTo(map);
                map.setView([lat, lng], 15);
            } else {
                boatMarker.setLatLng([lat, lng]);
                boatMarker.getElement().innerHTML = `<div class="shape-boat" style="transform:rotate(${myPos.heading}deg);"></div>`;
            }
            findNearest();
        }

        function dest(lat, lng, b, d) {
            const R = 3440.065, rLat = lat*Math.PI/180, rLng = lng*Math.PI/180, rB = b*Math.PI/180, rD = d/R;
            const lat2 = Math.asin(Math.sin(rLat)*Math.cos(rD) + Math.cos(rLat)*Math.sin(rD)*Math.cos(rB));
            const lng2 = rLng + Math.atan2(Math.sin(rB)*Math.sin(rD)*Math.cos(rLat), Math.cos(rD)-Math.sin(rLat)*Math.sin(lat2));
            return { lat: lat2*180/Math.PI, lng: lng2*180/Math.PI };
        }

        function render(c) {
            layer.clearLayers();
            const { start: s, wind: w, dist: d } = c;

            const m1 = dest(s.lat, s.lng, w, d);
            const reachA = (w - 115 + 360) % 360, reachL = d * 0.5;
            const m2 = dest(m1.lat, m1.lng, reachA, reachL);
            const gc = dest(m2.lat, m2.lng, (w + 180) % 360, d);
            const p3p = dest(gc.lat, gc.lng, (w - 90 + 360)%360, 0.02);
            const p3s = dest(gc.lat, gc.lng, (w + 90 + 360)%360, 0.02);
            const m4 = dest(gc.lat, gc.lng, w, d * 0.66);
            const m5 = dest(m4.lat, m4.lng, reachA, reachL * 0.85);
            const pin = dest(s.lat, s.lng, (w - 90 + 360)%360, 0.1);
            const fin = dest(s.lat, s.lng, (w + 90 + 360)%360, 0.1);

            activeMarks = [
                {id:"1", p:m1, t:"cyl"}, {id:"2", p:m2, t:"cyl"},
                {id:"3S", p:p3s, t:"cyl"}, {id:"3P", p:p3p, t:"cyl"},
                {id:"4", p:m4, t:"tri"}, {id:"5", p:m5, t:"tri"},
                {id:"S", p:s, t:"boat"}, {id:"P", p:pin, t:"pin"}, {id:"F", p:fin, t:"flag"}
            ];

            activeMarks.forEach(m => {
                if(m.t==='boat') return;
                const h = `<div class="shape-${m.t}"></div><div class="mark-label">${m.id}</div>`;
                L.marker(m.p, { icon: L.divIcon({ html:h, className:'x', iconSize:[30,30], iconAnchor:[15,15] }) }).addTo(layer);
            });

            // Lines
            L.polyline([s, m1], {color:'#555', dashArray:'5,5'}).addTo(layer);
            L.polyline([m1, m2, p3p], {color:'#ff0055', weight:2}).addTo(layer);
            L.polyline([m4, m5], {color:'#ffd700', weight:2}).addTo(layer);

            // Fit bounds
            map.fitBounds(activeMarks.map(m=>[m.p.lat, m.p.lng]), {padding:[50,50]});
        }

        function findNearest() {
            if(!activeMarks.length) return;
            let near = null, min = Infinity;
            activeMarks.forEach(m => {
                let d = map.distance(myPos, m.p);
                if(d < min) { min = d; near = m; }
            });
            if(near) document.getElementById('target-info').innerHTML = `To ${near.id}: <strong>${Math.round(min)}m</strong>`;
        }
    </script>
</body>
</html>
